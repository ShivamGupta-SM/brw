########################################################################################
#
# Docker Compose file optimized for Dokploy deployment
#
# Dokploy will:
# - Inject environment variables (configure in Dokploy UI)
# - Manage Traefik reverse proxy and SSL certificates
# - Pull this file from your Git repository
#
# Required environment variables to set in Dokploy:
# - SECRET_KEY
# - DATABASE_PASSWORD
# - REDIS_PASSWORD
# - BASEROW_PUBLIC_URL (your domain, e.g., https://baserow.yourdomain.com)
#
########################################################################################

x-backend-variables:
  &backend-variables
  SECRET_KEY: ${SECRET_KEY:?}
  BASEROW_JWT_SIGNING_KEY: ${BASEROW_JWT_SIGNING_KEY:-}
  DATABASE_PASSWORD: ${DATABASE_PASSWORD:?}
  REDIS_PASSWORD: ${REDIS_PASSWORD:?}

  # Dokploy will set this to your domain
  BASEROW_PUBLIC_URL: ${BASEROW_PUBLIC_URL:?}
  PUBLIC_BACKEND_URL: ${BASEROW_PUBLIC_URL}/api
  PUBLIC_WEB_FRONTEND_URL: ${BASEROW_PUBLIC_URL}

  # Enable secure proxy headers for Traefik
  BASEROW_ENABLE_SECURE_PROXY_SSL_HEADER: "true"

  # Internal URLs
  PRIVATE_BACKEND_URL: http://backend:8000

  # Database settings
  DATABASE_USER: ${DATABASE_USER:-baserow}
  DATABASE_NAME: ${DATABASE_NAME:-baserow}
  DATABASE_HOST: ${DATABASE_HOST:-db}
  DATABASE_PORT: ${DATABASE_PORT:-5432}

  # Redis settings
  REDIS_HOST: ${REDIS_HOST:-redis}
  REDIS_PORT: ${REDIS_PORT:-6379}

  # Email settings (optional)
  EMAIL_SMTP: ${EMAIL_SMTP:-}
  EMAIL_SMTP_HOST: ${EMAIL_SMTP_HOST:-}
  EMAIL_SMTP_PORT: ${EMAIL_SMTP_PORT:-}
  EMAIL_SMTP_USE_TLS: ${EMAIL_SMTP_USE_TLS:-}
  EMAIL_SMTP_USER: ${EMAIL_SMTP_USER:-}
  EMAIL_SMTP_PASSWORD: ${EMAIL_SMTP_PASSWORD:-}
  FROM_EMAIL: ${FROM_EMAIL:-}

  # S3 storage (optional - recommended for production)
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
  AWS_STORAGE_BUCKET_NAME: ${AWS_STORAGE_BUCKET_NAME:-}
  AWS_S3_REGION_NAME: ${AWS_S3_REGION_NAME:-}
  AWS_S3_ENDPOINT_URL: ${AWS_S3_ENDPOINT_URL:-}

  # Startup behavior
  MIGRATE_ON_STARTUP: ${MIGRATE_ON_STARTUP:-true}
  SYNC_TEMPLATES_ON_STARTUP: ${SYNC_TEMPLATES_ON_STARTUP:-true}

  # Performance settings
  BASEROW_AMOUNT_OF_WORKERS: ${BASEROW_AMOUNT_OF_WORKERS:-3}
  BASEROW_FILE_UPLOAD_SIZE_LIMIT_MB: ${BASEROW_FILE_UPLOAD_SIZE_LIMIT_MB:-100}

services:
  backend:
    image: baserow/backend:2.0.1
    restart: unless-stopped
    environment:
      <<: *backend-variables
    depends_on:
      - db
      - redis
    volumes:
      - media:/baserow/media
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.baserow-backend.rule=Host(`${TRAEFIK_HOST:-baserow.localhost}`) && PathPrefix(`/api`, `/ws`, `/media`)"
      - "traefik.http.routers.baserow-backend.entrypoints=websecure"
      - "traefik.http.routers.baserow-backend.tls=true"
      - "traefik.http.routers.baserow-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.baserow-backend.loadbalancer.server.port=8000"

  web-frontend:
    image: baserow/web-frontend:2.0.1
    restart: unless-stopped
    environment:
      BASEROW_PUBLIC_URL: ${BASEROW_PUBLIC_URL:?}
      PRIVATE_BACKEND_URL: http://backend:8000
      PUBLIC_BACKEND_URL: ${BASEROW_PUBLIC_URL}/api
      PUBLIC_WEB_FRONTEND_URL: ${BASEROW_PUBLIC_URL}
      BASEROW_DISABLE_PUBLIC_URL_CHECK: ${BASEROW_DISABLE_PUBLIC_URL_CHECK:-false}
      BASEROW_FRONTEND_SAME_SITE_COOKIE: ${BASEROW_FRONTEND_SAME_SITE_COOKIE:-lax}
    depends_on:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.baserow-frontend.rule=Host(`${TRAEFIK_HOST:-baserow.localhost}`)"
      - "traefik.http.routers.baserow-frontend.entrypoints=websecure"
      - "traefik.http.routers.baserow-frontend.tls=true"
      - "traefik.http.routers.baserow-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.baserow-frontend.loadbalancer.server.port=3000"
      - "traefik.http.routers.baserow-frontend.priority=1"

  celery:
    image: baserow/backend:2.0.1
    restart: unless-stopped
    environment:
      <<: *backend-variables
    command: celery-worker
    healthcheck:
      test: ["CMD-SHELL", "/baserow/backend/docker/docker-entrypoint.sh celery-worker-healthcheck"]
    depends_on:
      - backend
    volumes:
      - media:/baserow/media

  celery-export-worker:
    image: baserow/backend:2.0.1
    restart: unless-stopped
    command: celery-exportworker
    environment:
      <<: *backend-variables
    healthcheck:
      test: ["CMD-SHELL", "/baserow/backend/docker/docker-entrypoint.sh celery-exportworker-healthcheck"]
    depends_on:
      - backend
    volumes:
      - media:/baserow/media

  celery-beat-worker:
    image: baserow/backend:2.0.1
    restart: unless-stopped
    command: celery-beat
    environment:
      <<: *backend-variables
    stop_signal: SIGQUIT
    depends_on:
      - backend
    volumes:
      - media:/baserow/media

  db:
    image: pgvector/pgvector:pg15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DATABASE_USER:-baserow}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:?}
      POSTGRES_DB: ${DATABASE_NAME:-baserow}
    healthcheck:
      test: ["CMD-SHELL", 'su postgres -c "pg_isready -U ${DATABASE_USER:-baserow}"']
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:6
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:?}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

  volume-permissions-fixer:
    image: bash:4.4
    command: chown 9999:9999 -R /baserow/media
    volumes:
      - media:/baserow/media

volumes:
  pgdata:
  media:
